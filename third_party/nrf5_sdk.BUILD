load("@com_github_jemdiggity_rules_hex//:hex.bzl", "hex")

includes = [
    "components",
    "components/ble/common",
    "components/boards",
    "components/device",
    "components/drivers_nrf/clock",
    "components/drivers_nrf/common",
    "components/drivers_nrf/delay",
    "components/drivers_nrf/hal",
    "components/drivers_nrf/rng",
    "components/libraries/bootloader",
    "components/libraries/bootloader/ble_dfu",
    "components/libraries/bootloader/dfu",
    "components/libraries/crc32",
    "components/libraries/crypto",
    "components/libraries/crypto/backend/micro_ecc",
    "components/libraries/crypto/backend/nrf_crypto_sw",
    "components/libraries/ecc",
    "components/libraries/experimental_section_vars",
    "components/libraries/fstorage",
    "components/libraries/hci",
    "components/libraries/log",
    "components/libraries/log/src",
    "components/libraries/mem_manager",
    "components/libraries/queue",
    "components/libraries/scheduler",
    "components/libraries/sha256",
    "components/libraries/svc",
    "components/libraries/timer",
    "components/libraries/util",
    "components/softdevice/common/softdevice_handler",
    "components/toolchain",
    "components/toolchain/cmsis/include",
    "components/toolchain/gcc",
    "examples/dfu/bootloader_secure_ble",
    "examples/dfu/bootloader_secure/config",
    "external/micro-ecc/micro-ecc",
    "external/nano-pb",
]

includes_nrf52 = includes + [
    "components/softdevice/s132/headers",
    "components/softdevice/s132/headers/nrf52",
    "examples/dfu/bootloader_secure_ble/pca10040/config",
]

defines = [
    "SWI_DISABLE0",
    "SOFTDEVICE_PRESENT",
    "NRF_DFU_SETTINGS_VERSION=1",
    "__HEAP_SIZE=0",
    "SVC_INTERFACE_CALL_AS_NORMAL_FUNCTION",
    "BLE_STACK_SUPPORT_REQD",
    #fixme HACK how to generate keys..?
    "NRF_DFU_DEBUG_VERSION",
]

defines_nrf52 = defines + [
    "NRF_SD_BLE_API_VERSION=4",
    "BOARD_PCA10040",
    "NRF52",
    "S132",
    "NRF52832_XXAA",
    "NRF52_PAN_12",
    "NRF52_PAN_15",
    "NRF52_PAN_20",
    "NRF52_PAN_31",
    "NRF52_PAN_36",
    "NRF52_PAN_51",
    "NRF52_PAN_54",
    "NRF52_PAN_55",
    "NRF52_PAN_58",
    "NRF52_PAN_64",
    "NRF52_PAN_74",
    "CONFIG_GPIO_AS_PINRESET",
]

copts = [
    "-mthumb",
    "-mabi=aapcs",
    "-fno-builtin",
    "--short-enums",
    "-flto",
]

srcs = [
        "components/libraries/util/app_error_weak.c",
        "components/libraries/scheduler/app_scheduler.c",
        "components/libraries/timer/app_timer.c",
        "components/libraries/util/app_util_platform.c",
        "components/libraries/crc32/crc32.c",
        "components/libraries/fstorage/fstorage.c",
        "components/libraries/hci/hci_mem_pool.c",
        "components/libraries/mem_manager/mem_manager.c",
        "components/libraries/util/nrf_assert.c",
        "components/libraries/queue/nrf_queue.c",
        "components/libraries/strerror/nrf_strerror.c",
        "components/libraries/sha256/sha256.c",
        "examples/dfu/dfu_req_handling/dfu-cc.pb.c",
        "examples/dfu/dfu_req_handling/dfu_public_key.c",
        "examples/dfu/dfu_req_handling/dfu_req_handling.c",
        "components/boards/boards.c",
        "components/drivers_nrf/common/nrf_drv_common.c",
        "components/drivers_nrf/rng/nrf_drv_rng.c",
        "components/drivers_nrf/hal/nrf_nvmc.c",
        "components/libraries/bootloader/ble_dfu/nrf_ble_dfu.c",
        "components/libraries/crypto/nrf_crypto_ecdh.c",
        "components/libraries/crypto/nrf_crypto_ecdsa.c",
        "components/libraries/crypto/nrf_crypto_hash.c",
        "components/libraries/crypto/nrf_crypto_init.c",
        "components/libraries/crypto/nrf_crypto_keys.c",
        "components/libraries/crypto/nrf_crypto_mem.c",
        "components/libraries/crypto/nrf_crypto_rng.c",
        "examples/dfu/bootloader_secure_ble/main.c",
        "components/ble/common/ble_advdata.c",
        "components/ble/common/ble_conn_params.c",
        "components/ble/common/ble_srv_common.c",
        "external/nano-pb/pb_common.c",
        "external/nano-pb/pb_decode.c",
        "components/libraries/crypto/backend/micro_ecc/micro_ecc_lib_ecdh.c",
        "components/libraries/crypto/backend/micro_ecc/micro_ecc_lib_ecdsa.c",
        "components/libraries/crypto/backend/micro_ecc/micro_ecc_lib_init.c",
        "components/libraries/crypto/backend/micro_ecc/micro_ecc_lib_keys.c",
        "components/libraries/crypto/backend/micro_ecc/micro_ecc_lib_shared.c",
        "components/libraries/crypto/backend/nrf_crypto_sw/nrf_crypto_sw_hash.c",
        "components/libraries/crypto/backend/nrf_crypto_sw/nrf_crypto_sw_rng.c",
        "components/softdevice/common/softdevice_handler/softdevice_handler.c",
        "components/softdevice/common/softdevice_handler/softdevice_handler_appsh.c",
        "components/libraries/bootloader/nrf_bootloader.c",
        "components/libraries/bootloader/nrf_bootloader_app_start.c",
        "components/libraries/bootloader/nrf_bootloader_app_start_asm.c",
        "components/libraries/bootloader/nrf_bootloader_info.c",
        "components/libraries/bootloader/dfu/nrf_dfu.c",
        "components/libraries/bootloader/dfu/nrf_dfu_flash.c",
        "components/libraries/bootloader/dfu/nrf_dfu_handling_error.c",        
        "components/libraries/bootloader/dfu/nrf_dfu_mbr.c",
        "components/libraries/bootloader/dfu/nrf_dfu_settings.c",
        "components/libraries/bootloader/dfu/nrf_dfu_transport.c",
        "components/libraries/bootloader/dfu/nrf_dfu_utils.c",
    ]

cc_binary(
    name = "examples_dfu_bootloader_secure_ble_s132_pca10040",
    srcs = srcs + [
        "components/toolchain/gcc/gcc_startup_nrf52.S",
        "components/toolchain/system_nrf52.c",
    ] + glob(["**/*.h"]),
    copts = copts + [
        "-mcpu=cortex-m4",
        "-mfloat-abi=hard",
        "-mfpu=fpv4-sp-d16",
        ] +
        ["-D%s" % i for i in defines_nrf52] +
        ["-Iexternal/nrf5_sdk/%s" % i for i in includes_nrf52],
    linkopts = [
        # "-Xlinker -Map=output.map",
        "-mthumb",
        "-mabi=aapcs",
        "-Lexternal/nrf5_sdk/examples/dfu/bootloader_secure_ble",
        "-Lexternal/nrf5_sdk/components/toolchain/gcc",
        "-Lexternal/toolchain_gcc_arm_none/arm-none-eabi/lib/armv7e-m/fpu",
        "-Tsecure_dfu_gcc_pca10040.ld",
        "-mcpu=cortex-m4",
        "-mfloat-abi=hard",
        "-mfpu=fpv4-sp-d16",
        # use newlib in nano version
        "--specs=nano.specs",
        "-lnosys",
        "-lc",
        # "-lgcc",
    ],
    deps = [
        "components/toolchain/gcc/nrf52_common.ld",
        "examples/dfu/bootloader_secure_ble/secure_dfu_gcc_pca10040.ld",
        "@micro_ecc//:micro_ecc_nrf52",
    ],
)

hex(
    name = "examples_dfu_bootloader_secure_ble_s132_pca10040_hex",
    src = "examples_dfu_bootloader_secure_ble_s132_pca10040",
)
